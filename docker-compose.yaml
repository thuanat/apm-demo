version: "3.8"

networks:
  monitoring:

services:
  # --- 1. OpenTelemetry Collector ---
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.90.0
    container_name: otel-collector
    command: ["--config=/etc/otel-config.yaml"]
    volumes:
      - ./otel-config.yaml:/etc/otel-config.yaml
    ports:
      - "4317:4317" 
      - "4318:4318" 
      - "8889:8889" 
    networks:
      - monitoring

  # --- 2. Backends ---
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command: [--config.file=/etc/prometheus/prometheus.yml]
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml
    ports: ["9090:9090"]
    networks: [monitoring]

  loki:
    image: grafana/loki:latest
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml
    ports: ["3100:3100"]
    networks: [monitoring]

  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./tempo.yaml:/etc/tempo.yaml
    ports: ["3200:3200"]
    networks: [monitoring]

  # --- 3. Visualization ---
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports: ["3000:3000"]
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    networks: [monitoring]

  # --- 4. Demo Application (Đã sửa đổi) ---
  demo-app:
    image: node:18-slim
    container_name: demo-app
    working_dir: /usr/src/app
    volumes:
      - ./app:/usr/src/app
    environment:
      # Tên dịch vụ hiển thị trong Grafana
      - OTEL_SERVICE_NAME=demo-service
      # Trỏ endpoint về gRPC port của Collector
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      # Kích hoạt xuất dữ liệu cho cả 3 loại
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=otlp
      - OTEL_LOGS_EXPORTER=otlp
      # Cấu hình quan trọng để Log Injection hoạt động với Pino/Console
      - OTEL_NODE_RESOURCE_DETECTORS=env,host,os,process
      - OTEL_LOG_LEVEL=debug
    command: >
      sh -c "npm install && 
             node --require @opentelemetry/auto-instrumentations-node/register index.js"
    ports:
      - "8080:8080"
    networks:
      - monitoring
    depends_on:
      - otel-collector